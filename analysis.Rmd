---
title: "Reproduction Code for Local Commuter Rail Impact Analysis"
author: "Gerrit Hoving"
output:
  hmtl_document: default
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE) 
```

```{r include=FALSE}
library(tidyverse)
library(tidycensus)
library(sf)

# Imports Housing Price Index (HPI) Data by census tract from the Federal Housing Finance Agency
hpi_national <- read_csv("https://www.fhfa.gov/hpi/download/annually/hpi_at_bdl_tract.csv")
#hpi_national <- read_csv("C:/Users/Gerrit/Documents/ArcGIS/Projects/Local Commuter Rail History Final Project/hpi_at_bdl_tract.csv")
hpi_national <- hpi_national %>%
  rename(GEOID = tract)
```


```{r}
# Get data on relevent census tracts from US census
options(tigris_use_cache = TRUE)


northstar_counties <- c("Anoka", "Sherburne", "Wright", "Hennepin")

# Get the median household income data for each census tract in the specified counties
mn_census_data <- map_df(northstar_counties, function(county) {
  get_acs(
    geography = "tract",
    variables = "B01003_001", # Total population
    state = "27", # MN FIPS code
    county = county,
    geometry = TRUE,
    year = 2022
  )
})


wegostar_counties <- c("Davidson", "Sumner", "Wilson")

# Get the median household income data for each census tract in the specified counties
tn_census_data <- map_df(wegostar_counties, function(county) {
  get_acs(
    geography = "tract",
    variables = "B01003_001", # Total population
    state = "47", # TN FIPS code
    county = county,
    geometry = TRUE,
    year = 2022
  )
})

frontrunner_counties <- c("Salt Lake", "Utah", "Weber", "Morgan", "Davis")

# Get the median household income data for each census tract in the specified counties
ut_census_data <- map_df(frontrunner_counties, function(county) {
  get_acs(
    geography = "tract",
    variables = "B01003_001", # Total population
    state = "49", #UT FIPS Code
    county = county,
    geometry = TRUE,
    year = 2022
  )
})

railrunner_counties <- c("Santa Fe", "Valencia", "Bernalillo", "Sandoval")

# Get the median household income data for each census tract in the specified counties
nm_census_data <- map_df(railrunner_counties, function(county) {
  get_acs(
    geography = "tract",
    variables = "B01003_001", # Total population
    state = "35", #NM FIPS Code
    county = county,
    geometry = TRUE,
    year = 2022
  )
})

westside_counties <- c("Washington", "Yamhill", "Clackamas", "Marion", "Multnomah")

# Get the median household income data for each census tract in the specified counties
or_census_data <- map_df(westside_counties, function(county) {
  get_acs(
    geography = "tract",
    variables = "B01003_001", # Total population
    state = "41", # OR FIPS Code
    county = county,
    geometry = TRUE,
    year = 2022
  )
})

silverline_counties <- c("Allegheny")

# Get the median household income data for each census tract in the specified counties
pa_census_data <- map_df(silverline_counties, function(county) {
  get_acs(
    geography = "tract",
    variables = "B01003_001", # Total population
    state = "42", # PA FIPS Code
    county = county,
    geometry = TRUE,
    year = 2022
  )
})
```

```{r}
# Left join on GEOID
northstar_map <- mn_census_data %>%
  left_join(hpi_national, by = "GEOID")

# Test whether join was successful
plot(northstar_map["hpi2000"])

# Left join on GEOID
wegostar_map <- tn_census_data %>%
  left_join(hpi_national, by = "GEOID")

# Test whether join was successful
plot(wegostar_map["hpi2000"])

# Left join on GEOID
frontrunner_map <- ut_census_data %>%
  left_join(hpi_national, by = "GEOID")

# Test whether join was successful
plot(frontrunner_map["hpi2000"])

# Left join on GEOID
railrunner_map <- nm_census_data %>%
  left_join(hpi_national, by = "GEOID")

# Test whether join was successful
plot(railrunner_map["hpi2000"])

# Left join on GEOID
westside_map <- or_census_data %>%
  left_join(hpi_national, by = "GEOID")

# Test whether join was successful
plot(westside_map["hpi2000"])

# Left join on GEOID
silverline_map <- pa_census_data %>%
  left_join(hpi_national, by = "GEOID")

# Test whether join was successful
plot(silverline_map["hpi2000"])

```

```{r}
# Read commuter line shapefile
northstar_line <- st_read("./data/Alignments By Route.shp") %>% 
  filter(NameTransi == "Northstar")

# Read station shapefile
northstar_stations <- st_read("./data/Stations By Route.shp") %>% 
  filter(str_detect(Serves, 'Northstar'))

# Plot hpi data and add shapefiles
ggplot() +
  geom_sf(data = northstar_map, aes(fill = hpi2000), color = NA) +
  scale_fill_viridis_c(option = "plasma", name = "HPI") +
  geom_sf(data = northstar_line, color = "blue", size = 1) +       
  geom_sf(data = northstar_stations, color = "red", size = 2) +      
  labs(title = "HPI and Northstar Rail Line",
       subtitle = "Minneapolis-St. Paul Metro Area",
       caption = "Source: ACS 2022 and FHFA") +
  theme_minimal()


# Read commuter line shapefile
wegostar_line <- st_read("./data/Routes.shp") %>% 
  filter(LineName	== "WEGO STAR")

# Read station shapefile
wegostar_stations <- st_read("./data/Stops.shp") %>% 
  filter(str_detect(RoutesServ, '90'))

# Plot hpi data and add shapefiles
ggplot() +
  geom_sf(data = wegostar_map, aes(fill = hpi2000), color = NA) +
  scale_fill_viridis_c(option = "plasma", name = "HPI") +
  geom_sf(data = wegostar_line, color = "blue", size = 1) +       
  geom_sf(data = wegostar_stations, color = "red", size = 2) +      
  labs(title = "HPI and WeGo Star Rail Line",
       subtitle = "Nashville Metro Area",
       caption = "Source: ACS 2022 and FHFA") +
  theme_minimal()


getStations <- function(name, map, line_file, station_file) {
  line <- st_read(line_file)
  stations <- st_read(station_file)
  
  p <- ggplot() +
    geom_sf(data = map, aes(fill = hpi2000), color = NA) +
    scale_fill_viridis_c(option = "plasma", name = "HPI") +
    geom_sf(data = line, color = "blue", size = 1) +       
    geom_sf(data = stations, color = "red", size = 2) +      
    labs(title = paste0("HPI and ", name, " Rail Line"),
         caption = "Source: ACS 2022 and FHFA") +
    theme_minimal()
  print(p)
  
  return(list(l=line, s=stations))
}

data <- getStations("Frontrunner", frontrunner_map,
            "./data/UTA_FrontRunner_Commuter_Rail_Route_Centerline.shp", 
            "./data/FrontRunner_Commuter_Rail_Stations.shp")
frontrunner_line <- data$l 
frontrunner_staions <- data$s

data <- getStations("Rail Runner", railrunner_map,
            "./data/NMRX Line.shp", 
            "./data/NMRX Stops.shp")
railrunner_line <- data$l 
railrunner_staions <- data$s

data <- getStations("Westside Express", westside_map,
            "./data/WES Line.shp", 
            "./data/WES Stops.shp")
westside_line <- data$l 
westside_staions <- data$s

data <- getStations("Silver Line", silverline_map,
            "./data/Routes_2206_shp.shp", 
            "./data/PRT_Stations.shp")
silverline_line <- data$l 
silverline_staions <- data$s

#PRT_Stations_%26_Stops_-_October_2024
```





```{r}
generateFigures <- function(stations, map, yr_built, mid_distance=500, max_distance=10000) {
  # Make sure stations and tracts have the same CRS
  if (st_crs(stations) != st_crs(map)) {
    stations <- st_transform(stations, st_crs(map))
  }
  
  # Calculate the distance from each tract to all stations
  distance_matrix <- st_distance(map, stations)
  map$distance_to_station <- apply(distance_matrix, 1, min)
  
  # Classify data based on proximity to stations and time of construction
  map <- map %>%
    mutate(
      proximity = case_when(
        distance_to_station <= mid_distance ~ "Near station",
        distance_to_station <= max_distance ~ "Surrounding area"
      ),
      timing = case_when(
        year <= yr_built ~ "Before",
        year > yr_built ~ "After"
      ), 
      case = case_when(
        distance_to_station <= 500 & year <= yr_built ~ "Near station, before",
        distance_to_station <= 500 & year > yr_built ~ "Near station, after",
        distance_to_station <= 10000 & year <= yr_built ~ "Surrounging area, before",
        distance_to_station <= 10000 & year > yr_built ~ "Surrounding area, after"
      ),
    ) %>%
    filter(!is.na(proximity)) # Remove tracts that are more than 10 km away
  
  # Create a strip plot of HPI 
  p1 <- ggplot(map, aes(x = case, y = annual_change, 
                                 color = distance_to_station)) +
    geom_jitter(width = 0.2, alpha = 0.5) +
    geom_violin(fill = "#00000000") +
    labs(
      title = "HPI Comparison Based on Proximity to Stations",
      x = "Proximity to Station",
      y = "HPI Annual Change",
      caption = "Source: ACS 2022"
    ) +
    scale_color_viridis_c() +
    theme_minimal()
  
  # Create scatter plot and lines of best fit for distance vs annual change in HPI
  p2 <- ggplot(map) + 
    geom_point(aes(x = distance_to_station, y = annual_change, color = timing), 
               alpha = 0.2) +
    geom_smooth(aes(x = distance_to_station, y = annual_change, 
                    color = timing, group = timing), 
                method = "lm", se = FALSE) +
    labs(
      title = "Annual Change vs Distance to Station",
      x = "Distance to Station (m)",
      y = "Annual Change in Housing Price Index",
      color = "Timing"
    ) +
    theme_minimal()
  
  print(p1)
  print(p2)
}

generateFigures(northstar_stations, northstar_map, 2010)

```



```{r}
# Make sure stations and tracts have the same CRS
if (st_crs(northstar_stations) != st_crs(northstar_map)) {
  northstar_stations <- st_transform(northstar_stations, st_crs(northstar_map))
}

# Calculate the distance from each tract to all stations
distance_matrix <- st_distance(northstar_map, stations)
northstar_map$distance_to_station <- apply(distance_matrix, 1, min)

# Classify data based on proximity to stations and time of Northstar construction
northstar_map <- northstar_map %>%
  mutate(
    proximity = case_when(
      distance_to_station <= 500 ~ "Within 0.5 km",
      distance_to_station <= 10000 ~ "1 to 20 km"
    ),
    timing = case_when(
      year < 2010 ~ "Before Northstar",
      year >= 2010 ~ "After Northstar"
    ), 
    case = case_when(
      distance_to_station <= 500 & year < 2010 ~ "Within 0.5 km, before",
      distance_to_station <= 500 & year >= 2010 ~ "Within 0.5 km, after",
      distance_to_station <= 10000 & year < 2010 ~ "0.5 to 10 km, before",
      distance_to_station <= 10000 & year >= 2010 ~ "0.5 to 10 km, after"
    ),
  ) %>%
  filter(!is.na(proximity)) # Remove tracts that are more than 10 km away

# Create a strip plot of HPI 
ggplot(northstar_map, aes(x = case, y = annual_change, 
                               color = distance_to_station)) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  geom_violin(fill = "#00000000") +
  labs(
    title = "HPI Comparison Based on Proximity to Stations",
    x = "Proximity to Station",
    y = "HPI Annual Change",
    caption = "Source: ACS 2022"
  ) +
  scale_color_viridis_c() +
  theme_minimal()

# Create scatter plot and lines of best fit for distance vs annual change in HPI
ggplot(northstar_map) + 
  geom_point(aes(x = distance_to_station, y = annual_change, color = timing), 
             alpha = 0.2) +
  geom_smooth(aes(x = distance_to_station, y = annual_change, 
                  color = timing, group = timing), 
              method = "lm", se = FALSE) +
  labs(
    title = "Annual Change vs Distance to Station",
    x = "Distance to Station (m)",
    y = "Annual Change in Housing Price Index",
    color = "Timing"
  ) +
  theme_minimal()
```

# WeGo Star

```{r}
# Make sure stations and tracts have the same CRS
if (st_crs(wegostar_stations) != st_crs(wegostar_map)) {
  wegostar_stations <- st_transform(wegostar_stations, st_crs(wegostar_map))
}

# Calculate the distance from each tract to all stations
distance_matrix <- st_distance(wegostar_map, wegostar_stations)
wegostar_map$distance_to_station <- apply(distance_matrix, 1, min)

# Classify data based on proximity to stations and time of WeGo Star construction
wegostar_map <- wegostar_map %>%
  mutate(
    proximity = case_when(
      distance_to_station <= 500 ~ "Within 0.5 km",
      distance_to_station <= 10000 ~ "1 to 20 km"
    ),
    timing = case_when(
      year < 2007 ~ "Before WeGo Star",
      year >= 2007 ~ "After WeGo Star"
    ), 
    case = case_when(
      distance_to_station <= 500 & year < 2007 ~ "Within 0.5 km, before",
      distance_to_station <= 500 & year >= 2007 ~ "Within 0.5 km, after",
      distance_to_station <= 10000 & year < 2007 ~ "0.5 to 10 km, before",
      distance_to_station <= 10000 & year >= 2007 ~ "0.5 to 10 km, after"
    ),
  ) %>%
  filter(!is.na(proximity)) # Remove tracts that are more than 10 km away

# Create a strip plot of HPI 
ggplot(wegostar_map, aes(x = case, y = annual_change, 
                               color = distance_to_station)) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  geom_violin(fill = "#00000000") +
  labs(
    title = "HPI Comparison Based on Proximity to Stations",
    x = "Proximity to Station",
    y = "HPI Annual Change",
    caption = "Source: ACS 2022"
  ) +
  scale_color_viridis_c() +
  theme_minimal()

# Create scatter plot and lines of best fit for distance vs annual change in HPI
ggplot(wegostar_map) + 
  geom_point(aes(x = distance_to_station, y = annual_change, color = timing), 
             alpha = 0.2) +
  geom_smooth(aes(x = distance_to_station, y = annual_change, 
                  color = timing, group = timing), 
              method = "lm", se = FALSE) +
  labs(
    title = "Annual Change vs Distance to Station",
    x = "Distance to Station (m)",
    y = "Annual Change in Housing Price Index",
    color = "Timing"
  ) +
  theme_minimal()
```

# Frontrunner

```{r}
# Make sure stations and tracts have the same CRS
if (st_crs(frontrunner_stations) != st_crs(frontrunner_map)) {
  frontrunner_stations <- st_transform(frontrunner_stations, st_crs(frontrunner_map))
}

# Calculate the distance from each tract to all stations
distance_matrix <- st_distance(frontrunner_map, frontrunner_stations)
frontrunner_map$distance_to_station <- apply(distance_matrix, 1, min)

# Classify data based on proximity to stations and time of Frontrunner construction
frontrunner_map <- frontrunner_map %>%
  mutate(
    proximity = case_when(
      distance_to_station <= 500 ~ "Within 0.5 km",
      distance_to_station <= 10000 ~ "1 to 20 km"
    ),
    timing = case_when(
      year < 2010 ~ "Before Frontrunner",
      year >= 2010 ~ "After Frontrunner"
    ), 
    case = case_when(
      distance_to_station <= 500 & year < 2010 ~ "before, <0.5 km",
      distance_to_station <= 500 & year >= 2010 ~ "after, <0.5 km",
      distance_to_station <= 10000 & year < 2010 ~ "before, 0.5-10 km",
      distance_to_station <= 10000 & year >= 2010 ~ "after, 0.5-10 km"
    ),
  ) %>%
  filter(!is.na(proximity)) # Remove tracts that are more than 10 km away

# Create a strip plot of HPI 
ggplot(frontrunner_map, aes(x = case, y = annual_change, 
                               color = distance_to_station)) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  geom_violin(fill = "#00000000") +
  labs(
    title = "HPI Comparison Based on Proximity to Stations",
    x = "Proximity to Station",
    y = "HPI Annual Change",
    caption = "Source: ACS 2022"
  ) +
  scale_color_viridis_c() +
  theme_minimal()

# Create scatter plot and lines of best fit for distance vs annual change in HPI
ggplot(frontrunner_map) + 
  geom_point(aes(x = distance_to_station, y = annual_change, color = timing), 
             alpha = 0.2) +
  geom_smooth(aes(x = distance_to_station, y = annual_change, 
                  color = timing, group = timing), 
              method = "lm", se = FALSE) +
  labs(
    title = "Annual Change vs Distance to Station",
    x = "Distance to Station (m)",
    y = "Annual Change in Housing Price Index",
    color = "Timing"
  ) +
  theme_minimal()
```



```{r}
library(gganimate)
library(sf)

p1 <- ggplot(northstar_map %>% filter(year >= 2000)) +
  geom_sf(aes(fill = hpi), color = NA) +
  geom_sf(data = northstar_line, color = "blue", size = 1) +       
  geom_sf(data = northstar_stations, color = "red", size = 2) +     
  scale_fill_viridis_c(option = "plasma", name = "HPI") +
  labs(title = "HPI",
       subtitle = "Minneapolis-St. Paul  Metro Area",
       caption = "Year: {frame_time}") +
  theme_minimal() +
  theme(axis.text = element_blank(), axis.ticks = element_blank()) +
  transition_time(year)  # Set the transition to use the 'year' variable

# Display the animated plot
animate(p1, duration = 11, fps = 2, width = 800, height = 600)


p2 <- ggplot(wegostar_map %>% filter(year >= 2000)) +
  geom_sf(aes(fill = hpi), color = NA) +
  geom_sf(data = wegostar_line, color = "blue", size = 1) +       
  geom_sf(data = wegostar_stations, color = "red", size = 2) +     
  scale_fill_viridis_c(option = "plasma", name = "HPI") +
  labs(title = "HPI",
       subtitle = "Nashville Metro Area",
       caption = "Year: {frame_time}") +
  theme_minimal() +
  theme(axis.text = element_blank(), axis.ticks = element_blank()) +
  transition_time(year)  # Set the transition to use the 'year' variable

# Display the animated plot
animate(p2, duration = 11, fps = 2, width = 800, height = 600)


p3 <- ggplot(frontrunner_map %>% filter(year >= 2000)) +
  geom_sf(aes(fill = hpi), color = NA) +
  geom_sf(data = frontrunner_line, color = "blue", size = 1) +       
  geom_sf(data = frontrunner_stations, color = "red", size = 2) +     
  scale_fill_viridis_c(option = "plasma", name = "HPI") +
  labs(title = "HPI",
       subtitle = "Salt Lake City Metro Area",
       caption = "Year: {frame_time}") +
  theme_minimal() +
  theme(axis.text = element_blank(), axis.ticks = element_blank()) +
  transition_time(year)  # Set the transition to use the 'year' variable

# Display the animated plot
animate(p3, duration = 11, fps = 2, width = 800, height = 600)
```





